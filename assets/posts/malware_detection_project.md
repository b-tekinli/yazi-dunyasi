Malware Detection Projesi
==============

![](https://cdn-images-1.medium.com/max/800/0*O6bUCDNNv9DNFORK.jpg)

Merhabalar, Shuhari Researchers topluluğunda yeni araştırma konularımızdan biri olan malware nasıl tespit edilir, hangi araçlar kullanılır gibi konu başlıklarını ele aldıktan sonra basit bir malware tarayıcı geliştireceğiz. Bu proje, dosya hash’lerini kullanarak zararlı yazılım tespiti yapabilen bir tool olacak. Ben de bu projeyi yaparken araştırma ve ilerleme adımlarımı bu yazıda anlatıyor olacağım. İlk önce araştırma konularını anlatarak ilerleyeceğiz sonrasında da projenin geliştirilme aşamasını göreceğiz.

### Malware nedir?

Malware, “Malicious Software” kelimelerindeki ilk kelimenin ilk 3 harfi ve 2. kelimenin son 4 harfinin birleşiminden oluşan, Türkçe’ye de “kötü amaçlı yazılım” olarak çevrilen bir kelimedir. Temel amacı ise verileri çalmak, sistemi bozmak ya da gizlice kontrol altına almak amacıyla hareket etmektir. Buradan da sadece bilgisayar sistemlerine zarar vermek dışında, mobilde ve IoT cihazlarında da yer alabileceğini çıkartabiliriz.

### Malware Türleri

![](https://cdn-images-1.medium.com/max/800/1*XKY5-Rxo8LAyjxEVl_ykCA.png)

*   **_Virüs:_** Bir programın ya da dosyanın içine gizlenip sistemde yayılmaya çalışır. Kullanıcı bir dosyayı çalıştırdığı anda aktif olurlar genelde.
*   **_Worm (Solucan):_** Bir dosyaya bağlı kalmadan kendini kopyalayarak ağ üzerinden yayılır. Hızlıca sistemler arası da yayılabilir.
*   **_Trojan (Truva Atı):_** Fayda sağlayacakmış gibi görünen bir programdır fakat arka planda kötü amaçlı işler yapar. Kullanıcılar farkında olmadan bu tür yazılımları indirir ve çalıştırır.
*   **_Ransomware (Fidye Yazılım):_** Kullanıcının verilerini şifreler ve kurtarmak için de fidye talep eder.
*   **_Spyware (Casus Yazılım):_** Kullanıcıyı, fark ettirmeden izleyen ve kişisel bilgileri toplayan yazılımdır.
*   **_Adware (Reklam Yazılım):_** Sisteme istemsiz olarak reklam gösteren ya da pop-up’lar çıkaran yazılımlardır. Gelir elde etmek amacıyla kullanılır.
*   **_Rootkit:_** Sisteme gizlice erişim sağlayarak saldırganların kontrolü ele geçirmesini sağlar. Tespit edilmesi zordur ve sistemin derinliklerinde saklanır.
*   **_Botnet:_** Birden fazla bilgisayarın (bu bilgisayarlara zombi bilgisayarlar diyoruz) saldırganın kontrolü altına girmesiyle oluşan bir ağdır. Bu ağlar DDoS saldırıları amacıyla kullanılır.

* * *

### Malware nasıl analiz edilmelidir?

2 temel yöntem vardır. Bunlar statik analiz ve dinamik analizdir. Her ikisi de malware’in nasıl çalıştığını anlamak ve zararlı yazılımı etkisiz hale getirmek için kullanılır.

**Statik Analiz**  
Bu yöntem, malware’in kodunu çalıştırmadan incelemeye dayanır. Özellikle zararlı yazılımın dosya yapısını, içindeki metinleri ya da imzaları inceleyerek ne yaptığına dair fikir sahibi olabiliriz.

*   Statik analiz için kullanılan araç ve yöntemlere bakalım:  
    **_\* Disassembler ve Decompiler_** araçları için, malware’in içindeki makine dilini anlamak için kullanılırlar diyebiliriz. IDA Pro, Ghidra gibi araçları örnek verebiliriz.  
    **_\* Strings analizi_** ise, dosya içinde saklı olan düz metinleri tespit etmektir. Mesela `strings` komutuyla dosyanın içinde gömülü olan şifreler ya da URL’ler tespit edilebilir.

Bunlar dışında diğer malware tespit araçlarına SonarQube, Checkmarx, Fortify gibi araçları örnek verebiliriz.

**Dinamik Analiz**  
Malware’i çalıştırıp davranışlarını gözlemleyerek yapılan analizdir. Bu yöntemle malware’in sistemde ne tür dosyalar oluşturduğunu, hangi IP adreslerine bağlandığını ve hangi işlemleri başlattığını görebiliriz.

*   Dinamik analiz için kullanılan araç ve yöntemlere bakalım:  
    **_\* Sandboxlar_**, korumalı bir ortamda malware’i çalıştırıp zararlı etkilerini gözlemlemek için kullanılır. Buna Cuckoo Sandbox aracını örnek verebiliriz.  
    **_\* Debuggerlar_**, malware’in kodunu adım adım çalıştırıp neler olduğunu gözlemlemek için kullanılır. OllyDbg ya da x64dbg araçlarını örnek verebiliriz.

Bunlar dışında Burp Suite, Wireshark, Metasploit gibi araçların yaygın olarak kullanıldığını da söylemekte fayda var.

### Malware imzası nedir?

Malware imzası, belirli ve benzersiz bir özelliğini yani malware’in malware olduğunu anlamamızı sağlayan bir özelliğini ifade eder. Her malware türünün kendine özgü bir parmak izi olduğunu düşünebiliriz. Yazılımın kod yapısına ya da davranışlarına dayanarak oluşturulan bir tanımlayıcıdır. İmza tabanlı tespit sistemlerinde kullanılır ve dosyanın zararlı olup olmadığını belirlemek için dosyanın bu imzalarla karşılaştırılması yapılır.

Peki malware imzası nasıl oluşur? Şöyle, yukarıda yazılımın kod yapısından bahsetmiştik. Bu kod yapıları benzersiz olabilir ya da belirli karakter dizileri içerebilir. Bunlar da malware analizcileri tarafından “imza” olarak belirlenir. Yukarıda da söylediğimiz gibi her zararlı yazılım imzası onun parmak izi gibidir. Aynı türdeki zararlı yazılımlar aynı imzaya sahip olabilir.

**İmza türleri:**

*   **_Hash imzaları:_** Bir dosyanın hash değeri, dosyanın içeriğinin bir özetini oluşturur. Aynı dosya, her zaman aynı hash değerini üretir.
*   **_Byte dizisi imzaları:_** Dosya içindeki belirli kod parçaları ya da byte dizileri, malware imzası olarak belirlenir.
*   **_Davranışsal imzalar:_** Malware’in belirli bir sistemdeki davranışları (mesela hangi dosyaları açtığı ya da hangi IP adreslerine bağlandığı) da bir imza olabilir.

Bir örnek verelim mesela bir walware programı her çalıştığında `"malicious_function"` isminde bir fonksiyon çağırıyor. Bu fonksiyonun kodu şu şekilde olsun:

```
mov eax, 1  
int 0x80
````

Bu 2 satırlık kod malware’in imzası olarak tanımlanabilir ve bu kodu içeren dosyalar zararlı olarak işaretlenebilir.

* * *

### YARA Kuralları

![](https://cdn-images-1.medium.com/max/800/0*j0n4R8scohTQgkRI.png)

Öncelikle açılımı **_Yet Another Recursive Acronym_** olan bu kurallar, malware’i tespit etmek için kullanılır. YARA’nın amacı, dosyaların içeriğinde belirli desenleri takip ederek, bilinen kötü amaçlı yazılımları ve benzer davranışlar sergileyen yeni tehditleri tanımlamaktır yani kısaca malware’in imzasını tanımlamak için kullanılır. YARA, dosyadaki belirli karakterleri bulmakla sınırlı kalmayıp kullanıcı tanımlı kurallar oluşturmamıza da olanak verir.

**YARA kuralları nasıl çalışır?**  
Bir dosyanın belirli bir bölümünde belirli bir deseni, metni ya da karakter dizisini arar. Bir YARA kuralı nasıl yazılır ona bakıp örnek verirsek daha iyi anlarız.

*   **_Rule:_** Kuralın adı.
*   **_Strings:_** Aranacak belirli karakter dizileri.
*   **_Condition:_** Kuralın hangi durumlarda tetikleneceği (mesela, belirli bir dizi bulunduktan sonra).

Aşağıda YARA kuralı yapısına bakalım şimdi de.

```
rule MalwareExample  
{  
    meta:  
        description = "Malware tespit örneği"  
        author = "Beyza"  
        date = "2024-09-07"  
      
    strings:  
        $malicious\_string1 = "malicious\_function"  
        $malicious\_string2 = { E8 ?? ?? ?? ?? 85 C0 75 2E }  
  
    condition:  
        $malicious\_string1 or $malicious\_string2  
}
```

Bu kuralın detaylarına bakacak olursak:

*   **_Meta bölümü:_** Kural hakkında bilgi verir. Bu bölümde kuralın kim tarafından yazıldığı, tarihi ve açıklaması yer alır.
*   **_Strings bölümü:_** Malware’in içerdiği belirli karakter dizilerini tanımlar. İlk string bir düz metin ararken, ikincisi bir hexadecimal dizi arar. Hexadecimal, makine dilinde çalışacak olan talimatların gösterimi olabilir.
*   **_Condition bölümü:_** Kuralın ne zaman tetikleneceğini belirler. Mesela yukarıdaki örnek üzerinden gidecek olursak, dosyada `$malicious_string1` ya da `$malicious_string2` bulunduğunda kural tetiklenir.

Buraya kadar öğrendiklerimizden aslında avantajlarını da az çok anlamış olduk. Mesela kendi kurallarımızı yazmamıza imkan vermesi, aynı türden olup farklı varyantları bulunan zararlı yazılımlar için de genel kurallar yazmamıza olanak tanıması bize esneklik ve genelleme sağlıyor diyebiliriz. Aynı zamanda birçok farklı koşulu ve diziyi aynı kuralda kullanarak kompleks yapıları bile analiz edebiliriz burada da bize modüler yapı sunuyor. Bu sayede büyük dosya havuzları üzerinde çalıştırabiliriz. Sektörde de özellikle antivirüs şirketleri, güvenlik analistleri ve tehdit avcıları tarafından tercih ediliyor.

* * *

### Malware Detection’da Classification Methods Kullanımı

![](https://cdn-images-1.medium.com/max/800/1*DEv-jLLI644oZsxCdfQLdQ.png)

Sınıflandırma yöntemleri, bir dosyanın zararlı mı yoksa zararsız mı olduğunu anlamak için kullanılır. 2 ana sınıflandırma yöntemi vardır ve daha gelişmiş bir yöntem olan makine tabanlı sınıflandırma da mevcuttur. Şimdi bu yöntemlere bakalım.

1.  **İmza Tabanlı Tespit (Signature Based Detection)**  
    Bu yöntemde daha önce tanımlanmış zararlı yazılım örneklerinin imzaları (hash’ler ya da belirli byte dizileri) veri tabanında tutulur. Bir dosya tarandığında, dosyanın hash’i ya da kod parçaları bu imzalarla karşılaştırılır. Eğer bir eşleşme bulunursa, dosya zararlı olarak işaretlenir.  
    _Mesela bir zararlı yazılımın SHA-256 imzası veri tabanında bulunuyorsa ve taranan dosyanın hash değeri bu imzayla eşleşiyorsa, bu dosya zararlı olarak tespit edilebilir._  
    **_Avantajları_** arasında, hızlı olması ve belirli zararlı yazılımları %100 doğrulukla tespit edebildiğini sayabiliriz.  
    **_Dezavantajları_** içinse, yalnızca daha önce tanımlanmış malware’leri tespit etmesi yani yeni tür malware’ler ya da varyantları bu yöntemi aşabilir diyebiliriz.
2.  **Herustik/Daavranış Tabanlı Tespit (Heuristic/Behavior-Based Detection)**  
    Bu yöntemde, dosyanın nasl davrandığına bakılır. Mesela bir program:  
    \- Kayıt defterini değiştirmeye çalışıyor mu?  
    \- Gizli bir şekilde ağ üzerinden veri mi gönderiyor?  
    \- Sistem dosyalarını mı değiştiriyor?  
    Eğer dosya şüpheli bir davranış sergiliiyorsa, bu dosya zararlı olarak işaretlenebilir. Bu yöntemin özellikle yeni malware türlerinin tespitinde etkili olduğunu söylemekte fayda var.  
    Mesela bir dosya taranırken, birden fazla şüpheli davranış gözlemleniyorsa (örnek olarak, dosya sistemi üzerinde yetkisiz değişiklikler yapıyorsa), bu dosya zararlı olarak sınıflandırılabilir.  
    **_Avantajları_** arasında, yeni ve bilinmeyen tehditleri tespit edebilmesi, zamanla daha akıllı hale gelip makine öğrenimi kullanılarak güncellenebilir olmasını sıralayabiliriz.  
    **_Dezavantajları_** arasında ise, yanlış ve pozitif sonuçlar verebilir yani zararsız bir dosyayı zararlı olarak işaretleyebilmesini söyleyebiliriz.
3.  **Makine Öğrenimi Tabanlı Sınıflandırma**  
    Makine öğrenimi, büyük miktarda veriden öğrenerek yeni tür malware’leri tespit etmekte kullanılır. Model, zararlı ve zararsız dosyalar üzerinde eğitilerek bir dosyanın hangi sınıfa ait olduğunu tahmin eder.  
    _Mesela, bir makine öğrenme modeline çeşitli zararlı yazılım dosyaları verilir ve bu model yeni bir dosya üzerinde çalıştırıldığında, dosyanın zararlı olup olmadığını %95 doğrulukla tahmin eder._

* * *

> Yazının başında malware ile temel araştırma konularını bildikten sonra bir malware tarayıcısı geliştireceğimizden bahsetmiştim. Bu bölümde de önce bu tarayıcının ne olduğundan bahsedeceğim. Bu araçların arka planda nasıl çalıştığını, dosyaların zararlı ya da zararsız olduklarını nasıl tespit ettiğini bilmeden kodlamaya başlamak mümkün değil.

### Malware tarayıcısı nedir?

![](https://cdn-images-1.medium.com/max/800/0*OscpBpwYIL4OgJ1d.jpg)

Sistem üzerinde zararlı yazılım olup olmadığını tespit etmek amacıyla tarama yapan bir yazılımdır. Şu şekilde çalışır:

*   Bilinen malware’lerin imzaları veri tabanında saklanır.
*   Sistem tarandığında dosyaların hash’leri çıkarılır ve bu hash’ler veri tabanındaki imzalarla karşılaştırılır.
*   Eğer bir eşleşme bulunursa, bu dosya muhtemelen zararlıdır.

**Peki hash tabanlı tespitler nasıl yapılır?**  
Bir dosyanın içeriğinin benzersiz bir hash’ini oluşturup bu hash’in zararlı yazılımların bilinen hash’leri ile karşılaştırılmasına dayanır. Yukarıda da anlattığımız gibi, eğer bir dosyanın hash değeri, bilinen bir malware’in hash değeriyle eşleşirse, dosya zararlı olarak işaretlenir. En yaygın kullanılan 3 hash algoritmasına bakalım:

*   **_MD5:_** Hızlı ama artık güvenli görülmüyor çünkü collision (çakışmalar) bulundu.
*   **_SHA-1:_** MD5'ten daha güvenli fakat bu da zayıf olarak görülüyor.
*   **_SHA-256:_** En yaygın ve güvenli görülen hash algoritmasıdır.

**Hash nasıl hesaplanır?**  
Hash hesaplama, bir dosyanın içeriğinden sabit uzunlukta bir hash üretme işlemi diyebiliriz. Python ile bir dosyanın hash’ini nasıl hesaplayacağımıza bakalım:

```
import hashlib  
  
def hash\_file(file\_path):  
    sha256\_hash = hashlib.sha256()  
    with open(file\_path, "rb") as f:  
        \# dosyayı küçük parçalar halinde okuyoruz  
        for byte\_block in iter(lambda: f.read(4096), b""):  
            sha256\_hash.update(byte\_block)  
    return sha256\_hash.hexdigest()  
  
\# örnek kullanımı ise şöyle:  
file\_hash = hash\_file("ornek\_dosya.exe")  
print(f"SHA-256 hash değeri: {file\_hash}")
````

Yukarıdaki örnekte bir dosyanın SHA-256 hash değerini hesaplayıp çıktı olarak ekrana basıyor.

**Malware tespiti ve analizinde nelere dikkat etmeliyiz?**  
\* İmza tabanlı tespit için kullandığımız veri tabanlarının güncel olmasına dikkat etmeliyiz. Sürekli yeni malware’ler ortaya çıktığı için eski imzalar yetersiz kalabilir.  
\* Sadece imza tabanlı tespit her zaman yeterli olmayabilir bu yüzden davranışlara dayalı tespit yöntemleri de kullanmalıyız. Mesela bir dosya sürekli olarak sistem dosyalarını değiştiriyorsa, bu şüpheli bir davranış olabilir.  
\* Malware’i analiz ederken kendi bilgisayarımıza zarar vermemek adına Sandbox gibi izole ortamlarda çalışmalıyız.

* * *

Araştırma konularımız bitti ve gerekli olan her şeyi öğrendiğimizi düşünüyorum. Şimdi de proje geliştirme aşamasına geçelim. Projemi [**_BeyzInfectify_**](https://github.com/b-tekinli/BeyzInfectify) olarak adlandırdım 😅 Şöyle, Detectify (Tespit) ve Infect (Enfekte etmek) kelimelerinin birleşimiyle zararlı yazılım analizi projesi olduğunu belirtmek, Beyz ise kişisel bir dokunuş olması açısından adımın uygun olduğunu düşündüm.

İlk adım olarak malware tespiti için yukarıdaki araştırmalarımız doğrultusunda bir hash veritabanı kullanmamız gerektiğini öğrendik. Ben basit bir başlangıç olması için [VirusShare](https://virusshare.com/) kullanacağım.

Elimizde bir `.txt` uzantılı dosya olduğu için öncelikle bunu Python ile nasıl kullanacağımızı bulmalıyız. Dosyanın her satırında hash olduğunu düşünelim:

```
abcd1234efg567..  
9876qwer543zxc..  
...
```

Bu dosyayı python ile okuyabilmeliyiz. Şu şekilde okuyalım:

```
def read\_hash\_db(file\_path): \# dosya yolunu parametre olarak verdim  
    hash\_list = \[\] \# veritabanında okuduğum hashleri bu diziye ekleyeceğim  
  
    with open(file\_path, 'r') as file: \# burada dosyayı açtım ve okumaya başlıyorum  
        for line in file: \# dosyanın her satırını line olarak alıyorum  
            hash\_list.append(line.strip()) \# okuduğum hash'i temizleyip listeye ekliyorum  
  
    return hash\_list \# listeyi döndürüyorum
```

Burada `hash_list` adındaki listeyi oluşturduk ve içine hash’leri atıyoruz ama neden atıyoruz nerede kullanacağız diye sorabilirsiniz. Bu listeyi daha sonra hash’leri karşılaştırmak için kullanacağımız için oluşturduk.

2\. adım olarak hash’leri hesaplamalıyız. Bunun için de Python’un `hashlib` modülünü kullanacağız. Yine araştırmalarımız sonucunda, en güvenli algoritma olduğunu öğrendiğimiz `SHA-256` kullanacağız.

```
import hashlib  
  
def calculate\_file\_hash(file\_path):  
    with open(file\_path, 'rb') as f: \# dosyayı binary modda açıyorum  
        sha256\_hash = hashlib.sha256() \# SHA-256 hash hesaplayıcısını oluşturuyorum  
          
        \# dosyayı parça parça okuyup hash hesaplamasını yapıyorum  
        for byte\_block in iter(lambda: f.read(4096), b""):  
            sha256\_hash.update(byte\_block)  
      
      
    return sha256\_hash.hexdigest() \# hash değerini 16'lık tabanda döndürüyorum
```

Yukarıdaki fonksiyonda kısaca dosya yolunu parametre olarak aldık ve dosyanın hash değerini `hexdigest()` fonksiyonu sayesinde hexadecimal tabanda döndürdük.

3\. adım olarak dosyaları tarayıp karşılaştırma yapmamız gerekiyor. Şimdi de dizindeki dosyaların hash’lerini bir önceki adımda yazdığımız fonksiyon sayesinde hesaplayarak elimizdeki hash veritabanıyla karşılaştıracağız. Python’un `os` modülüyle belirli bir dizindeki tüm dosyaları bulabiliriz:

```
import os  
  
# taranacak dizini ve hash listesini parametre olarak veriyorum  
def scan\_directory(directory\_path, hash\_list):  
    # os.walk --> dizin içindeki tüm dosyaları tarayıp her dosyanın hash'ini hesaplamaya yarar  
    for root, dirs, files in os.walk(directory\_path):  
        for file\_name in files:  
            file\_path = os.path.join(root, file\_name)  
              
            file\_hash = calculate\_file\_hash(file\_path) \# dosyanın hash'ini hesaplıyoruz  
              
            # hesaplanan hash'i veritabanındaki hash'lerle karşılaştırıyorum  
            if file\_hash in hash\_list:  
                print(f"Zararlı yazılım tespit edildi: {file\_path}")  
            else:  
                print(f"Temiz dosya: {file\_path}")
```

4\. adım olarak sonuçları kaydetmemiz gerekiyor yani loglama yapacağız. Sonuçları bir dosyaya kaydetmek için Python’un `logging` modülünü kullanacağız.

```
import logging  
  
# log dosyasını ayarlıyoruz  
logging.basicConfig(filename='scan\_results.log', level=logging.INFO)  
  
def log\_results(file\_path, is\_malware):  
    if is\_malware:  
        logging.info(f"Zararlı yazılım bulundu: {file\_path}")  
        print(f"Zararlı yazılım bulundu: {file\_path}")  
    else:  
        logging.info(f"Temiz dosya: {file\_path}")  
        print(f"Temiz dosya: {file\_path}")
```

Artık veritabanını okuyabilen, dosyaların hash’lerini hesaplayıp zararlı olup olmadığını kontrol edebilen, sonuçları loglayan bir malware tarayıcımız var.

Buna ek olarak, veritabanını güncel tutmak için bir fonksiyon yazabiliriz. Parametre olarak veritabanı URL’i vererek yeni veritabanını indirip kaydetmesini sağlayan küçük bir fonksiyon olabilir. Bunu da ilgisi olan biri yazıp bana PR atarsa memnuniyetle kabul ederim 🫠

Hem projenin hem de yazının sonuna geldik. Malware hakkında genelgeçer bilgi birikimine sahiptim şimdi çok daha fazlasına sahibim hatta elimde malware analizi yapabileceğim küçük bir tarayıcım bile var 🥳 Benim için çok verimli bir süreç oldu. Mentörümüz Gözde hocamıza ne kadar teşekkür etsek az kalır. Umarım herkes için verimli bir yazı olmuştur. Kolaylıklar 💫
